name: C/C++ Vulnerability Detection

on:
  push:
    branches: [ "main", "master", "develop" ]
    paths:
      - '**.c'
      - '**.cpp'
      - '**.h'
      - '**.hpp'
  pull_request:
    branches: [ "main", "master" ]
    paths:
      - '**.c'
      - '**.cpp'
      - '**.h'
      - '**.hpp'
  workflow_dispatch:  # Allow manual trigger

jobs:
  vulnerability-scan:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write  # For SARIF upload

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: "3.9"
        cache: 'pip'

    - name: Install system dependencies (Clang)
      run: |
        sudo apt-get update
        sudo apt-get install -y libclang-dev llvm clang

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tensorflow numpy clang

    - name: Download model artifacts
      run: |
        # Option 1: Download from GitHub Releases
        # curl -L https://github.com/${{ github.repository }}/releases/download/v1.0/model.keras -o model.keras
        # curl -L https://github.com/${{ github.repository }}/releases/download/v1.0/vocab.json -o vocab.json
        
        # Option 2: Use artifacts from the repo (if committed)
        # Model and vocab should be in models/ directory
        echo "Using model artifacts from repository"

    - name: Clone vulnerability scanner
      run: |
        # Clone the scanner repository
        git clone https://github.com/hoangduy0308/c-vulnerability-detection.git scanner
        
    - name: Run Vulnerability Scanner
      id: scan
      run: |
        cd scanner
        python -m inference.cli scan ${{ github.workspace }} \
          --model .github/models/best_model.keras \
          --vocab .github/models/vocab.json \
          --config .github/models/config.json \
          --recursive \
          --format sarif \
          --output ${{ github.workspace }}/results.sarif \
          --threshold 0.4809

    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: results.sarif
        category: "vulnerability-scanner"

    - name: Generate text report
      if: always()
      run: |
        cd scanner
        python -m inference.cli scan ${{ github.workspace }} \
          --model .github/models/best_model.keras \
          --vocab .github/models/vocab.json \
          --recursive \
          --format text

    - name: Check for vulnerabilities
      run: |
        cd scanner
        python -m inference.cli scan ${{ github.workspace }} \
          --model .github/models/best_model.keras \
          --vocab .github/models/vocab.json \
          --recursive \
          --format json \
          --fail-on-vuln
